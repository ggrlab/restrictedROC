---
title: "Datatypes 04: Microbiome"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>"
)
```




```{r setup}
options(warn = 1)
library(restrictedROC)
```
```{r data}
library(dplyr)
dir.create("intermediate_data")
data_joint <- dataMelanoma::lozano2022_pheno_cytof
table(data_joint[["Severe irAE status (1=Yes, 0=No)d"]])
```

```{r, initial rROC plots}
cytof_features <- grep("^cytof", colnames(data_joint), value = TRUE)
library(ggplot2)
pdf("intermediate_data/2022-Lozano/2022-Lozano-NatMed_restrictedFeatures.pdf")
tmp <- sapply(cytof_features, function(x) {
    data_single_feature <- data_joint[[x]]
    print(
        restrictedROC::plot_density_rROC_empirical(
            values_grouped = split(data_single_feature, data_joint[["Severe irAE status (1=Yes, 0=No)d"]]),
            xmin = min(data_single_feature),
            xmax = max(data_single_feature)
        )[["plots"]] + patchwork::plot_annotation(title = x)
    )
})
dev.off()
```

```{r, permutation tests}
cytof_permutation_rroc <- restrictedROC::rROC(
    data_joint,
    dependent_vars = "Severe irAE status (1=Yes, 0=No)d",
    independent_vars = cytof_features,
    n_permutations = 1000,
    positive_label = 1,
    direction = "<",
    parallel_permutations = FALSE
)
qs::qsave(cytof_permutation_rroc, file = "intermediate_data/2022-Lozano/cytof_permutation_rroc.RData")
cytof_permutation_rroc <- qs::qread("intermediate_data/2022-Lozano/cytof_permutation_rroc.RData")
```

```{r, Re-plot Fig 2c}
library(ggplot2)
permpvals <- restrictedROC:::summary.rROC(cytof_permutation_rroc)
permpvals[["qval.twoside.max"]] <- p.adjust(permpvals[["pval.twoside.max"]], method = "BH")
permpvals[["qval.twoside.global"]] <- p.adjust(permpvals[["pval.twoside.global"]], method = "BH")

pdf("intermediate_data/2022-Lozano/2022-Lozano-NatMed_volcano.pdf")
print(
    ggplot(permpvals, aes(x = global.auc, y = -log10(qval.twoside.global))) +
        geom_point() +
        geom_hline(yintercept = -log10(0.05), color = "red") +
        geom_vline(xintercept = 0.5, color = "red") +
        geom_text(aes(label = level_2), size = .75, col = "darkgreen") +
        theme_bw() +
        theme(
            axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
            legend.position = "none"
        ) +
        ggtitle("Global AUC")
)
print(
    ggplot(permpvals, aes(x = max_total.auc, y = -log10(qval.twoside.max))) +
        geom_point() +
        geom_hline(yintercept = -log10(0.05), color = "red") +
        geom_vline(xintercept = 0.5, color = "red") +
        geom_text(aes(label = level_2), size = .75, col = "darkgreen") +
        theme_bw() +
        theme(
            axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
            legend.position = "none"
        ) +
        ggtitle("Max AUC")
)
dev.off()


pdf("intermediate_data/2022-Lozano/2022-Lozano-NatMed_maxVSglobal.pdf")
print(
    ggplot(permpvals, aes(x = qval.twoside.global, y = qval.twoside.max)) +
        geom_point() +
        geom_hline(yintercept = 0.05, color = "red") +
        geom_vline(xintercept = 0.05, color = "red") +
        scale_x_log10() +
        scale_y_log10() +
        # label feature with q.value < 0.05
        ggrepel::geom_text_repel(
            data = subset(
                permpvals,
                qval.twoside.global > 0.05 & qval.twoside.max < 0.05
            ),
            aes(label = level_2),
            size = 1.5, col = "darkgreen",
            min.segment.length = 0,
            max.overlaps = 5
        ) +
        ggpubr::theme_pubr() +
        theme(
            axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
            legend.position = "none"
        )
)
dev.off()
```

```{r, Paper plot}
source(file.path("vignettes", "articles", "paper_utils.R"))
library(dplyr)
cool_feature <- "cytof_CD4+ T Cell (EMRA)"
tmp <- paper_performance(
    values_grouped = split(data_joint[[cool_feature]], data_joint[["Severe irAE status (1=Yes, 0=No)d"]]),
    positive_label = "1",
    plot_n_points = 0,
    current_rroc = permpvals |> dplyr::filter(level_2 == cool_feature),
    outcome = "Severe irAE status (1=Yes, 0=No)",
    feature = cool_feature,
    heights = c(.9, .1)
)
pdf("intermediate_data/2022-Lozano/2022-Lozano-NatMed_foundAdditional.pdf", height = 8)
print(tmp)
dev.off()
```

[1]: Lozano, A.X., Chaudhuri, A.A., Nene, A. et al. T cell characteristics associated with toxicity to immune checkpoint blockade in patients with melanoma. Nat Med 28, 353â€“362 (2022). https://doi.org/10.1038/s41591-021-01623-z 
